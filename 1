// ==UserScript==
// @name         Tucaoè§†é¢‘é“¾æ¥å¤åˆ¶æ‚¬æµ®çª— (åŠ¨æ€æŸ¥æ‰¾ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      2.1
// @description  åœ¨tucaoç½‘ç«™é¡µé¢åŠ¨æ€æŸ¥æ‰¾å¹¶å¤åˆ¶è§†é¢‘é“¾æ¥
// @author       ******
// @match        https://www.tucao.my/*
// @grant        GM_addStyle
// @grant        GM_notification
// @grant        GM_setClipboard
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // æ·»åŠ æ‚¬æµ®çª—CSSæ ·å¼ï¼ˆä¸ä¹‹å‰ä¿æŒä¸€è‡´ï¼‰
    GM_addStyle(`
        .tucao-floating-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            transition: all 0.3s ease;
            user-select: none;
            overflow: hidden;
        }
        .tucao-floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .tucao-floating-btn:active {
            transform: scale(0.95);
        }
        .tucao-copy-notification {
            position: fixed;
            right: 80px;
            bottom: 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000000;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .tucao-copy-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .tucao-copy-notification.error {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
        }
    `);

    // ä¸»åˆå§‹åŒ–å‡½æ•°
    function init() {
        // åˆ›å»ºæ‚¬æµ®çª—
        createFloatingButton();
    }

    function createFloatingButton() {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æŒ‰é’®
        if (document.querySelector('.tucao-floating-btn')) return;

        // åˆ›å»ºæŒ‰é’®
        const button = document.createElement('button');
        button.className = 'tucao-floating-btn';
        button.title = 'ç‚¹å‡»å¤åˆ¶è§†é¢‘é“¾æ¥';
        button.innerHTML = 'ğŸ”—';

        // åˆ›å»ºæç¤ºæ¶ˆæ¯
        const notification = document.createElement('div');
        notification.className = 'tucao-copy-notification';
        notification.textContent = 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼';

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(button);
        document.body.appendChild(notification);

        // ç‚¹å‡»äº‹ä»¶å¤„ç†
        button.addEventListener('click', async function() {
            const videoUrl = findVideoUrl();

            if (!videoUrl) {
                showNotification(notification, 'âŒ æœªæ‰¾åˆ°å¯ç”¨çš„è§†é¢‘é“¾æ¥', 'error');
                return;
            }

            try {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                await GM_setClipboard(videoUrl, 'text');

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showNotification(notification, 'âœ… è§†é¢‘é“¾æ¥å·²å¤åˆ¶ï¼');

                // æŒ‰é’®åé¦ˆåŠ¨ç”»
                button.innerHTML = 'âœ…';
                button.style.background = 'linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%)';

                setTimeout(() => {
                    button.innerHTML = 'ğŸ”—';
                    button.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }, 1000);

            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                showNotification(notification, 'âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'error');
            }
        });
    }

    // **æ ¸å¿ƒï¼šåŠ¨æ€æŸ¥æ‰¾è§†é¢‘é“¾æ¥çš„å‡½æ•°**
    function findVideoUrl() {
        let videoUrl = '';
        const debug = false; // è®¾ç½®ä¸ºtrueå¯åœ¨æ§åˆ¶å°æŸ¥çœ‹æŸ¥æ‰¾è¿‡ç¨‹

        // ç­–ç•¥1ï¼šç›´æ¥æŸ¥æ‰¾æ‰€æœ‰videoå…ƒç´ 
        const videoElements = document.querySelectorAll('video');
        if (debug) console.log(`æ‰¾åˆ° ${videoElements.length} ä¸ªvideoå…ƒç´ `);

        for (const video of videoElements) {
            if (video.src && video.src.trim() !== '' && !video.src.startsWith('blob:')) {
                videoUrl = video.src;
                if (debug) console.log('ç­–ç•¥1æˆåŠŸ: ä»videoå…ƒç´ æ‰¾åˆ°', videoUrl);
                return videoUrl;
            }
        }

        // ç­–ç•¥2ï¼šæŸ¥æ‰¾å…·æœ‰ç‰¹å®šclassçš„videoï¼ˆé’ˆå¯¹DPlayeræ’­æ”¾å™¨ï¼‰
        const dplayerVideo = document.querySelector('.dplayer-video, .dplayer-video-current');
        if (dplayerVideo && dplayerVideo.src) {
            videoUrl = dplayerVideo.src;
            if (debug) console.log('ç­–ç•¥2æˆåŠŸ: ä»dplayer-videoæ‰¾åˆ°', videoUrl);
            return videoUrl;
        }

        // ç­–ç•¥3ï¼šåœ¨åµŒå¥—çš„iframeä¸­æŸ¥æ‰¾
        const iframes = document.querySelectorAll('iframe');
        if (debug) console.log(`æ‰¾åˆ° ${iframes.length} ä¸ªiframe`);
        // æ³¨æ„ï¼šç”±äºè·¨åŸŸé™åˆ¶ï¼Œç›´æ¥è¯»å–iframeå†…å®¹å¯èƒ½å—é™ï¼Œè¿™é‡Œåªåšç®€å•å°è¯•
        for (const iframe of iframes) {
            if (iframe.src && iframe.src.includes('video') || iframe.src.includes('player')) {
                videoUrl = iframe.src;
                if (debug) console.log('ç­–ç•¥3: ä»iframe srcæ‰¾åˆ°å¯èƒ½çš„æ’­æ”¾å™¨åœ°å€', videoUrl);
                // æ³¨æ„ï¼šè¿™å¯èƒ½æ˜¯æ’­æ”¾å™¨é¡µé¢åœ°å€ï¼Œè€Œéç›´æ¥è§†é¢‘é“¾æ¥
                break;
            }
        }

        // ç­–ç•¥4ï¼šä»é¡µé¢scriptæˆ–metaæ ‡ç­¾ä¸­æŸ¥æ‰¾å¯èƒ½çš„è§†é¢‘é…ç½®
        if (!videoUrl) {
            const scripts = document.querySelectorAll('script');
            for (const script of scripts) {
                const content = script.textContent || script.innerHTML;
                // æŸ¥æ‰¾å¸¸è§çš„è§†é¢‘URLæ¨¡å¼
                const urlPatterns = [
                    /(https?:\/\/[^\s"'<>]+?\.(mp4|m3u8|flv|avi|mov|wmv|mkv|webm))(?=["'&\s])/gi,
                    /"url"\s*:\s*"([^"]+\.(mp4|m3u8|flv|avi|mov|wmv|mkv|webm))"/i,
                    /"src"\s*:\s*"([^"]+\.(mp4|m3u8|flv|avi|mov|wmv|mkv|webm))"/i,
                    /video_url["']?\s*[:=]\s*["']([^"']+\.(mp4|m3u8|flv|avi|mov|wmv|mkv|webm))["']/i
                ];

                for (const pattern of urlPatterns) {
                    const match = content.match(pattern);
                    if (match && match[1]) {
                        videoUrl = match[1];
                        if (debug) console.log('ç­–ç•¥4æˆåŠŸ: ä»scriptæ‰¾åˆ°', videoUrl);
                        return videoUrl;
                    }
                }
            }
        }

        // ç­–ç•¥5ï¼šæœ€åçš„å°è¯• - åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­æœç´¢URL
        if (!videoUrl) {
            const bodyText = document.body.innerHTML;
            const videoUrlRegex = /(https?:\/\/[^\s"'<>]+?\.(mp4|m3u8|flv|avi|mov|wmv|mkv|webm))(?=["'&\s<>])/gi;
            const matches = bodyText.match(videoUrlRegex);
            if (matches && matches.length > 0) {
                // è¿‡æ»¤æ‰å¯èƒ½ä¸æ˜¯ç›´æ¥è§†é¢‘é“¾æ¥çš„URLï¼ˆä¾‹å¦‚å›¾æ ‡ã€æ ·å¼ç­‰ï¼‰
                const filtered = matches.filter(url =>
                    !url.includes('logo') &&
                    !url.includes('icon') &&
                    !url.includes('.css') &&
                    !url.includes('.js')
                );
                if (filtered.length > 0) {
                    videoUrl = filtered[0];
                    if (debug) console.log('ç­–ç•¥5æˆåŠŸ: ä»å…¨æ–‡æœç´¢æ‰¾åˆ°', videoUrl);
                }
            }
        }

        if (debug && !videoUrl) console.log('æ‰€æœ‰æŸ¥æ‰¾ç­–ç•¥å‡æœªæ‰¾åˆ°è§†é¢‘é“¾æ¥');
        return videoUrl;
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showNotification(element, message, type = 'success') {
        element.textContent = message;
        element.className = `tucao-copy-notification ${type === 'error' ? 'error' : ''} show`;

        setTimeout(() => {
            element.classList.remove('show');
        }, 2000);
    }

    // å¯åŠ¨è„šæœ¬
    // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿é¡µé¢å…ƒç´ åŠ è½½å®Œæˆ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        // å¦‚æœé¡µé¢å·²ç»åŠ è½½ï¼Œç¨å¾®å»¶è¿Ÿä¸€ä¸‹ä»¥ç¡®ä¿æ’­æ”¾å™¨åˆå§‹åŒ–
        setTimeout(init, 800);
    }
})();
